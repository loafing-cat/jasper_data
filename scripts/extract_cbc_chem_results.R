# clear environment
rm(list = ls()); gc()

# load necessary libraries
pacman::p_load(tidyverse, pdftools, here, rio, lubridate)

# specify path to PDF file and read its content
pdf_path <- here("input_text_data")
raw_text <- pdf_text(here(pdf_path, "desert_ridge_test_results.pdf"))

# extract all dates labeled 'date of result'; used to date when metrics reported
dates_of_result <- str_extract_all(raw_text, "\\s*DATE OF RESULT:\\s*(\\d{1,2}/\\d{1,2}/\\d{2})")[[1]] %>% 
  print()

# clean 1st instance of date string by removing preceding text
date_of_result <- str_replace(dates_of_result[1], ".*DATE OF RESULT:\\s*", "")

# reformat date
formatted_date <- mdy(date_of_result) %>% 
  format("%Y-%m-%d") %>% 
  print()

# function to clean text by removing unnecessary headers, footers, and other repetitive details
clean_text <- function(text) {
  text %>% 
    str_replace_all("Generated by VetConnect.*", "") %>% 
    str_replace_all("JASPER THAI.*", "") %>% 
    str_replace_all("PET OWNER: DIANE THAI.*", "") %>% 
    str_split("\n") %>%  # split the string into separate lines
    unlist() %>%  # convert the list of lines into a vector
    str_trim() %>%  # trim whitespace
    .[. != ""]  # remove empty lines
}

# apply cleaning function to raw text
cleaned_text <- clean_text(raw_text)

# determine start indices for hematology and chemistry sections and partition cleaned text accordingly
hematology_start <- which(cleaned_text == "Hematology")
chemistry_start <- which(cleaned_text == "Chemistry")
hematology_text <- cleaned_text[hematology_start:(chemistry_start - 1)]
chemistry_text <- cleaned_text[(chemistry_start + 1):length(cleaned_text)]

# print each line of the hematology section to observe structure
for (line in hematology_text) {
  cat(line, "\n")
}

# function to parse cleaned text into a dataframe, extracting metrics and values
parse_section <- function(section_text) {
  data_frame <- tibble(line = section_text) %>%
    filter(str_detect(line, "\\d")) %>% # filter out rows with non-numeric values
    mutate(
      metric = str_extract(line, "^[^\\d\\r\\n]+(?=\\s*\\d)"),  # extract metric names, avoiding numbers
      value = str_extract(line, "\\s*(\\d+\\.?\\d*)"),  # extract numeric values
      date_of_result = formatted_date  # append the formatted date to each entry
    ) %>%
    select(-line) %>%  # remove the original line column
    filter(!is.na(metric))  # exclude entries without metric names
  return(data_frame)
}

# parse and label hematology and chemistry data, trimming any whitespace
hematology_df <- parse_section(hematology_text) %>% 
  mutate(test = "hematology") %>% 
  mutate_all(str_trim)

chemistry_df <- parse_section(chemistry_text) %>% 
  mutate(test = "chemistry") %>% 
  mutate_all(str_trim)

# combine hematology and chemistry data, and rename metrics that weren't extracted correctly
results <- bind_rows(hematology_df, chemistry_df) %>% 
  mutate(metric = case_when(
    metric == "BUN: Creatinine" ~ "BUN: Creatinine Ratio",
    metric == "Albumin:" ~ "Albumin: Globulin Ratio",
    TRUE ~ metric
  ))

# specify variable datatypes
results <- results %>% 
  mutate(
    metric = as.character(metric),
    value = as.numeric(value),
    date_of_result = as.Date(date_of_result),
    test = as.character(test)
  )

# create a date variable with different format for exporting
date_for_export <- format(as.Date(formatted_date), "%Y_%m_%d")

# write data to .Rdata file; append date of results to end of file name
export(results, here("output_data", paste0("cbc_chem_", date_for_export, ".Rdata")))

# write data to csv file; append date of results to end of file name
export(results, here("output_data", paste0("cbc_chem_", date_for_export, ".csv")), append = FALSE)